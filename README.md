# Лабораторная работа №7: Создание многоконтейнерного приложения

## Цель работы

Ознакомиться с работой многоконтейнерного приложения на базе docker-compose.

## Задание

Создать PHP-приложение на базе трёх контейнеров: nginx, php-fpm, mariadb, используя docker-compose.

## Ход работы

### 1. Клонирование пустого Git-репозитория

```bash
git clone git@github.com:iurii1801/containers07.git
```

### 2. Создание структуры проекта

Созданы папки `nginx/` и `mounts/site/`, куда позже будет размещён сайт.

```bash
mkdir -p mounts/site
mkdir nginx
```

### 3. Создание файлов `.gitignore` и `README.md`

```bash
New-Item -Name ".gitignore" -ItemType "File"
New-Item -Name "README.md" -ItemType "File"
```

### 4. Добавлено правило в `.gitignore`

```text
# Ignore files and directories
mounts/site/*
```

### 5. Создание конфигурации nginx

Создан файл `nginx/default.conf` со следующим содержимым:

```nginx
server {
    listen 80;
    server_name _;
    root /var/www/html;
    index index.php;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        fastcgi_pass backend:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
```

### 6. Создание переменных окружения

#### 6.1 Создание файла mysql.env

Создан файл `mysql.env` в корне проекта:

```env
MYSQL_ROOT_PASSWORD=secret
MYSQL_DATABASE=app
MYSQL_USER=user
MYSQL_PASSWORD=secret
```

#### 6.2 Создание файла app.env

Создан файл `app.env` в корне проекта. Он предназначен для хранения пользовательских переменных окружения, которые можно переиспользовать в нескольких сервисах. Это удобно для настройки общих параметров, таких как версии приложения, режим работы, параметры путей и другие конфигурационные данные, которые должны быть доступны одновременно как `frontend`, так и `backend`. Такой подход способствует более чистой архитектуре, лучшей управляемости и облегчает развертывание приложения в разных средах (например, dev, test, prod).

```env
APP_VERSION=1.0.0
```

Этот файл содержит пользовательскую переменную окружения `APP_VERSION`, которую можно использовать внутри контейнеров для отображения информации о версии приложения, ведения логов или другой конфигурации. Переменная подключается в `docker-compose.yml` к сервисам `frontend` и `backend` через параметр `env_file`. Это позволяет централизованно управлять значениями и использовать их в конфигурациях или PHP-коде (например, через `getenv('APP_VERSION')`).

### 7. Создание docker-compose.yml

Файл `docker-compose.yml` в корне проекта:

```yaml
version: '3.9'

services:
  frontend:
    image: nginx:1.19
    volumes:
      - ./mounts/site:/var/www/html
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    ports:
      - "80:80"
    networks:
      - internal
    env_file:
      - app.env

  backend:
    image: php:7.4-fpm
    volumes:
      - ./mounts/site:/var/www/html
    networks:
      - internal
    env_file:
      - mysql.env
      - app.env

  database:
    image: mysql:8.0
    env_file:
      - mysql.env
    networks:
      - internal
    volumes:
      - db_data:/var/lib/mysql

networks:
  internal: {}

volumes:
  db_data: {}
```

### 8. Запуск контейнеров и тестирование

```bash
docker-compose up -d
```

Контейнеры успешно запущены и взаимодействуют между собой. Сайт работает по адресу: [http://localhost](http://localhost).

---

## Вопросы и ответы

### В каком порядке запускаются контейнеры?

Контейнеры запускаются независимо друг от друга, так как `docker-compose` по умолчанию не управляет порядком готовности сервисов. Однако их порядок можно частично контролировать с помощью параметра `depends_on`. Например, можно указать, что контейнер `backend` зависит от `database`, но это не гарантирует, что база будет готова к подключению. Поэтому необходимо реализовать задержку или проверку соединения с БД в коде или скриптах инициализации.

### Где хранятся данные базы данных?

Данные MySQL сохраняются внутри тома `db_data`, который подключается к контейнеру базы данных по пути `/var/lib/mysql`. Это обеспечивает сохранность данных при перезапуске контейнеров или при пересборке проекта. Docker volume работает независимо от жизненного цикла контейнера и остаётся доступным, даже если контейнер был удалён.

### Как называются контейнеры проекта?

Docker Compose формирует имена контейнеров из названия директории проекта и названия сервиса. Например, при запуске в папке `containers07` имена контейнеров будут следующими: `containers07_frontend_1`, `containers07_backend_1`, `containers07_database_1`. Это позволяет точно понимать структуру и принадлежность каждого контейнера.

### Для чего нужен файл app.env и переменная APP_VERSION?

Файл `app.env` создан для хранения пользовательской переменной окружения `APP_VERSION`, которая может использоваться внутри контейнеров `frontend` и `backend`. Эта переменная может применяться для отображения версии приложения в интерфейсе, для логирования, отладки, условной логики исполнения или конфигурации. Использование файла окружения позволяет централизованно управлять переменными и облегчает переносимость и масштабируемость проекта. Значение переменной может быть получено, например, через PHP-функцию `getenv('APP_VERSION')` и отображено на странице сайта или в логе. Это делает проект более управляемым и гибким.

---

## Выводы

В результате лабораторной работы было развёрнуто многоконтейнерное приложение с использованием Docker Compose. Все три контейнера — nginx, php-fpm и mariadb — были успешно настроены и связаны через внутреннюю сеть. Конфигурация nginx была переопределена для правильной обработки PHP-файлов, а в контейнерах были использованы переменные окружения, включая пользовательскую переменную `APP_VERSION`, подключённую через отдельный файл `app.env`.

Проект протестирован локально, сайт корректно отображается при обращении к `http://localhost`, PHP-код обрабатывается, и взаимодействие с базой данных проходит успешно. Работа показала важность использования конфигурационных файлов, переменных окружения и volumes для управления состоянием приложения. Полученные навыки углубляют понимание контейнеризации и подготовки современных web-приложений к развёртыванию.

---

## Библиография

1. [Официальная документация Docker](https://docs.docker.com/)
2. [Документация Docker Compose](https://docs.docker.com/compose/)
3. [DockerHub: php:7.4-fpm](https://hub.docker.com/_/php)
4. [DockerHub: nginx](https://hub.docker.com/_/nginx)
5. [DockerHub: mysql](https://hub.docker.com/_/mysql)
6. [PHP: getenv – Официальная документация](https://www.php.net/manual/ru/function.getenv.php)
7. [Nginx: FastCGI конфигурация](https://nginx.org/ru/docs/http/ngx_http_fastcgi_module.html)